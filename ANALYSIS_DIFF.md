# Анализ различий между коммитами

## Коммиты для сравнения
- **Коммит 1**: `2491373e683f099b9ef8fd67fced96968ef1b00f` (30.12.2025)
- **Коммит 2**: `144c40d025c784ba2cc52d4ddf727892cace187d` (06.01.2026)

## Общая статистика изменений

**Всего изменено файлов**: 145
- **Добавлено строк**: 5,829
- **Удалено строк**: 51,898
- **Чистое изменение**: -46,069 строк (значительное сокращение кодовой базы)

## Основные категории изменений

### 1. Удаление тестовых страниц и документации

**Удалено множество тестовых страниц** (более 30 файлов):
- `src/app/test-*` - все тестовые страницы
- `src/app/bridge*` - страницы для моста
- `src/app/cctp-*` - страницы для CCTP транзакций
- `src/app/minting-aptos/page.tsx`
- `src/app/recover-signer/page.tsx`
- `src/app/swagger/page.tsx`

**Удалена документация** (более 20 MD файлов):
- C4 диаграммы
- Гайды по интеграции
- Документация по настройке окружения
- Различные фиксы и гайды

**Результат**: Проект стал значительно чище и более поддерживаемым.

### 2. Рефакторинг системы транзакций и Gas Station

#### Изменения в `WalletProvider.tsx`:
- **Удалено**: `setupAutomaticSolanaWalletDerivation` - автоматическая деривация Solana кошельков
- **Упрощена** логика инициализации Gas Station
- **Изменен подход**: Gas Station теперь настраивается через `AptosConfig` вместо глобального `transactionSubmitter`

#### Изменения в `useTransactionSubmitter.ts`:
- **Полностью переписан** хук транзакций
- **Добавлена логика** проверки баланса APT перед отправкой транзакции
- **Умное переключение**: 
  - Если у пользователя есть APT и транзакция не APT-токен → обычная транзакция
  - Если нет APT или транзакция APT-токена → используется Gas Station с `withFeePayer: true`
- **Упрощена** структура кода (удалено ~200 строк сложной логики нормализации authenticator)

#### Изменения в `GasStationService.ts`:
- **Упрощена** инициализация клиента
- **Удален** `GasStationTransactionSubmitter` (теперь используется напрямую `GasStationClient`)
- **Изменен** способ создания клиента: `createGasStationClient` вместо `new GasStationClient`

#### Изменения в `useDeposit.ts`:
- **Интегрирован** новый `useTransactionSubmitter` хук
- **Упрощена** логика отправки транзакций
- **Улучшена** обработка ошибок

### 3. Удаление Solana интеграции

**Удалены файлы**:
- `src/lib/services/solana/portfolio.ts` (243 строки)
- `src/lib/services/solana/tokenMetadata.ts` (123 строки)
- `src/lib/wallet/getSolanaWalletAddress.ts`
- `src/lib/wallet/getSolanaWalletSigner.ts`
- `src/hooks/useSolanaPortfolio.ts`
- `src/components/SolanaSignMessageButton.tsx`
- `src/components/SolanaWalletSelector.tsx`
- `src/components/portfolio/SolanaWalletCard.tsx`
- `src/app/api/solana/portfolio/route.ts`

**Результат**: Проект сфокусирован только на Aptos блокчейне.

### 4. Удаление Wormhole/CCTP интеграции

**Удалены файлы**:
- `src/lib/wormhole/initCCTP.ts` (187 строк)
- `src/lib/wormhole/signers.ts` (64 строки)
- `src/lib/services/wormhole/bridge.ts`
- `src/lib/hooks/useBridge.ts`
- `src/components/bridge/*` - все компоненты моста
- `src/app/bridge*` - все страницы моста

**Результат**: Убрана функциональность кросс-чейн мостов.

### 5. Улучшения UI компонентов

#### `YieldCalculatorModal.tsx`:
- **Добавлена** функциональность шаринга расчетов через ссылку
- **Улучшена** вкладка APR с поддержкой начальных значений:
  - `initialAprStart`, `initialAprCurrent`, `initialAprDays`
  - `initialAprStartDate`, `initialAprEndDate`
  - `initialAprMode` ('days' | 'dates')
- **Добавлено** управление активной вкладкой
- **Добавлена** функциональность копирования ссылки с уведомлениями

#### Новые shared компоненты:
- `src/shared/Badge/Badge.tsx` - переиспользуемый компонент бейджа
- `src/shared/Badge/Badge.module.css` - стили для бейджа
- `src/shared/ProtocolIcon/ProtocolIcon.tsx` - компонент иконки протокола
- `src/shared/ProtocolIcon/ProtocolIcon.module.css` - стили для иконки

### 6. Изменения в конфигурации протоколов

#### `poolsConfig.ts`:
- **Улучшена** обработка Auro пулов:
  - Добавлена логика сопоставления BORROW пулов с COLLATERAL пулами
  - Теперь `borrowAPY` берется из соответствующего BORROW пула
- **Удален** источник данных Earnium pools API

#### `protocolsList.json`:
- **Изменен** `depositType` для Joule с "native" на "external"
- **Обновлен** `logoUrl` для Thala на локальный путь `/protocol_ico/thala.png`

### 7. Улучшения в wallet store

#### `walletStore.ts`:
- **Улучшен** расчет `getTotalValue()`:
  - Добавлен учет незаявленных наград внутри позиций (Hyperion)
  - Улучшена обработка rewards стора
  - Добавлена поддержка различных форматов данных (Auro может храниться как объект)
- **Добавлена** обработка `deposits` и `supplies` массивов в позициях

### 8. Удаление контекстов

- **Удален** `AptosClientContext.tsx` - контекст для Aptos клиента
- **Удален** `ThemeContext.tsx` - заменен на `next-themes` (миграция в `ThemeProviderWrapper.tsx`)

### 9. Обновления зависимостей

- **Обновлен** `package.json`:
  - Next.js обновлен до версии 15.4.10
  - Удалены зависимости, связанные с Solana и Wormhole
  - Обновлены другие зависимости

### 10. Мелкие улучшения

- **Улучшена** обработка ошибок в `aptBalance.ts` (fallback на 1 APT при ошибке)
- **Добавлено** логирование в `wallet.ts`
- **Улучшена** обработка транзакций в `useWithdraw.ts`
- **Обновлены** стили в `globals.css`
- **Улучшена** интеграция ChatPanel через `ChatPanelWrapper`

## Ключевые архитектурные изменения

### До (коммит 2491373e):
- Поддержка Solana и Aptos
- Интеграция с Wormhole для кросс-чейн мостов
- Сложная система транзакций с ручной нормализацией authenticator
- Множество тестовых страниц
- Глобальная настройка Gas Station через `transactionSubmitter`

### После (коммит 144c40d):
- Только Aptos блокчейн
- Упрощенная система транзакций с умным выбором Gas Station
- Чистая кодовая база без тестовых страниц
- Локальная настройка Gas Station через `withFeePayer` флаг
- Улучшенные shared компоненты
- Лучшая обработка данных протоколов

## Влияние на функциональность

### ✅ Улучшено:
- Производительность (меньше кода)
- Поддерживаемость (чистая кодовая база)
- UX транзакций (умный выбор Gas Station)
- Компоненты UI (новые shared компоненты)
- Обработка данных протоколов (лучший расчет значений)

### ❌ Удалено:
- Поддержка Solana
- Кросс-чейн мосты (Wormhole/CCTP)
- Тестовые страницы (но это улучшение)
- Документация (но это может быть проблемой)

## Рекомендации

1. **Документация**: Рассмотреть возможность восстановления важной документации или создания новой
2. **Тестирование**: Убедиться, что удаление тестовых страниц не повлияло на функциональность
3. **Gas Station**: Протестировать новую логику выбора Gas Station на различных сценариях
4. **Миграция**: Если нужна поддержка Solana или мостов, потребуется восстановление функциональности


